name: Sync Products from XBZ to OMIE

on:
  # Run every 3 hours - syncs up to 500 products per run to avoid OMIE rate limits
  # With 8 runs/day Ã— 500 products = 4000 new products can be synced daily
  schedule:
    # - cron: '0 */3 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      max_inserts:
        description: 'Maximum products to insert (default: 500)'
        required: false
        default: '500'
  
  # Run on push to main branch (optional)
  #push:
  #  branches:
  #    - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run product sync
        id: sync
        env:
          XBZ_TOKEN: ${{ secrets.XBZ_TOKEN }}
          XBZ_CNPJ: ${{ secrets.XBZ_CNPJ }}
          OMIE_APP_KEY: ${{ secrets.OMIE_APP_KEY }}
          OMIE_APP_SECRET: ${{ secrets.OMIE_APP_SECRET }}
          MAX_INSERTS_PER_RUN: ${{ github.event.inputs.max_inserts || '500' }}
        run: |
          python -m app.main
      
      - name: Upload sync logs and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_number }}
          path: |
            logs/
            *_products.csv
            skipped_products.csv
            failed_products.csv
          retention-days: 30


